<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI assistant</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    /* code block / copy UI */
    .code-wrapper { position: relative; margin: 12px 0; }
    .code-wrapper .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.4);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .code-wrapper pre {
      margin: 0;
      padding: 16px;
      border-radius: 8px;
      background: rgba(0,0,0,0.45);
      color: #e6fffa;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.45;
      max-height: 360px;
      white-space: pre;
    }
    code.inline-code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    // copy helper exposed to inline onclick in sanitized HTML
    window.copyCode = function(btn) {
      try {
        const wrapper = btn.closest('.code-wrapper');
        const codeEl = wrapper?.querySelector('pre code');
        if (!codeEl) return;
        const text = codeEl.innerText;
        navigator.clipboard.writeText(text).then(() => {
          const prev = btn.innerText;
          btn.innerText = 'Copied';
          setTimeout(() => btn.innerText = prev, 1400);
        });
      } catch (e) { console.warn(e); }
    };

    const Send = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m22 2-7 20-4-9-9-4Z"/>
        <path d="M22 2 11 13"/>
      </svg>
    );
    
    const Sparkles = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
        <path d="M5 3v4"/>
        <path d="M19 17v4"/>
        <path d="M3 5h4"/>
        <path d="M17 19h4"/>
      </svg>
    );
    
    const Bot = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/>
        <path d="M20 14h2"/>
        <path d="M15 13v2"/>
        <path d="M9 13v2"/>
      </svg>
    );
    
    const User = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
    );
    
    const Trash2 = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 6h18"/>
        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
        <line x1="10" x2="10" y1="11" y2="17"/>
        <line x1="14" x2="14" y1="11" y2="17"/>
      </svg>
    );

    function GroqChatbot() {
      // sanitizes text and converts markdown/code/strong to safe HTML with copyable code blocks
      const sanitizeAndHighlight = (text) => {
        if (!text) return '';
        const escapeHtml = s => String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

          
        // First, convert fenced code blocks ```...``` to a copyable HTML block.
        // Work on the raw text to preserve code content then escape it.
        text = String(text);
        text = text.replace(/```([\s\S]*?)```/g, (m, code) => {
          const esc = escapeHtml(code);
          return `<div class="code-wrapper"><button class="copy-btn" onclick="copyCode(this)" aria-label="Copy code">Copy</button><pre><code>${esc}</code></pre></div>`;
        });

        // Escape remaining HTML and handle inline code `like this`
        // (escape everything first, then restore the fenced blocks which are already escaped)
        // split on code-wrapper markers to avoid double escaping blocks we already inserted
        const parts = text.split(/(<div class="code-wrapper">[\s\S]*?<\/div>)/g);
        for (let i = 0; i < parts.length; i++) {
          if (!parts[i].startsWith('<div class="code-wrapper">')) {
            // escape, then convert **bold** and <strong> (escaped) and inline `code`
            parts[i] = escapeHtml(parts[i])
              .replace(/\*\*(.+?)\*\*/g, '<span class="highlight">$1</span>')
              .replace(/&lt;strong&gt;(.+?)&lt;\/strong&gt;/g, '<span class="highlight">$1</span>')
              .replace(/`(.+?)`/g, '<code class="inline-code">$1</code>')
              .replace(/\n/g, '<br/>');
          }
        }
        return parts.join('');
      };
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [sessionId] = useState(() => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);
      const [error, setError] = useState(null);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      const API_URL = 'http://localhost:3001/api';

      const scrollToBottom = () => {
        const container = document.querySelector('.scrollbar-custom');
        if (container) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        else messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        inputRef.current?.focus();
      }, []);

      // keep header + input heights in CSS variables so the messages area fills remaining space
      useEffect(() => {
        const header = document.getElementById('app-header');
        const inputArea = document.getElementById('app-input');
        if (!header || !inputArea) return;
        const setHeights = () => {
          document.documentElement.style.setProperty('--header-height', `${header.offsetHeight}px`);
          document.documentElement.style.setProperty('--input-height', `${inputArea.offsetHeight}px`);
        };
        setHeights();
        const ro = new ResizeObserver(setHeights);
        ro.observe(header);
        ro.observe(inputArea);
        window.addEventListener('resize', setHeights);
        return () => { ro.disconnect(); window.removeEventListener('resize', setHeights); };
      }, []);

      const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!inputValue.trim() || isLoading) return;

        const userMessage = inputValue.trim();
        setInputValue('');
        setIsLoading(true);
        setError(null);

        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);

        try {
          const response = await fetch(`${API_URL}/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: userMessage,
              sessionId: sessionId
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to get response');
          }

          const data = await response.json();
          
          setMessages(prev => [...prev, { role: 'assistant', content: data.message }]);
        } catch (error) {
          console.error('Error:', error);
          setError(error.message);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: `I apologize, but I encountered an error: ${error.message}. Please try again.`
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleClearChat = async () => {
        try {
          await fetch(`${API_URL}/clear`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sessionId }),
          });
          setMessages([]);
          setError(null);
        } catch (error) {
          console.error('Error clearing chat:', error);
        }
      };

      return (
        <div style={{
          minHeight: '100vh',
          /* CSS variables for header and input heights */
          '--header-height': '175px',
          '--input-height': '100px',
           background: 'linear-gradient(to bottom right, rgb(6, 78, 59), rgb(17, 94, 89), rgb(22, 78, 99))',
           display: 'flex',
           flexDirection: 'column'
         }}>
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@300;400;500;600&display=swap');
            
            @keyframes slideUp {
              from {
                opacity: 0;
                transform: translateY(30px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }

            @keyframes float {
              0%, 100% { transform: translateY(0px); }
              50% { transform: translateY(-10px); }
            }

            @keyframes pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.5; }
            }

            .message-enter {
              animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

            .float-animation {
              animation: float 3s ease-in-out infinite;
            }

            .typing-indicator span {
              animation: pulse 1.4s infinite;
            }

            .typing-indicator span:nth-child(2) {
              animation-delay: 0.2s;
            }

            .typing-indicator span:nth-child(3) {
              animation-delay: 0.4s;
            }

            .glass-effect {
              background: rgba(255, 255, 255, 0.05);
              backdropFilter: blur(20px);
              border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .scrollbar-custom {
              /* enable visible scrollbar only for this container */
              overflow-y: auto;
              scrollbar-gutter: stable both-edges;
              -webkit-overflow-scrolling: touch;
              scroll-padding-top: var(--header-height);
              /* Firefox */
              scrollbar-width: thin;
              scrollbar-color: rgba(16,185,129,0.85) rgba(6,78,59,0.16);
            }
  
            /* WebKit / Chromium */
            .scrollbar-custom::-webkit-scrollbar {
              width: 12px;
              height: 12px;
            }
            .scrollbar-custom::-webkit-scrollbar-track {
              background: rgba(6,78,59,0.12);
              border-radius: 10px;
            }
            .scrollbar-custom::-webkit-scrollbar-thumb {
              background: linear-gradient(180deg, rgba(52,211,153,0.95), rgba(20,184,166,0.85));
              border-radius: 10px;
              border: 2px solid rgba(6,78,59,0.12);
            }
            .scrollbar-custom::-webkit-scrollbar-thumb:hover {
              filter: brightness(0.95);
            }

            .message-bubble:hover {
              transform: translateY(-2px);
            }
            /* highlight style for bold text inside bot responses */
            .highlight {
              background: rgba(255, 230, 120, 0.25);
              color: inherit;
              padding: 2px 6px;
              border-radius: 6px;
              font-weight: 700;
            }
          `}</style>

          {/* Header */}
          <div id="app-header" className="glass-effect" style={{
            position: 'sticky',
            top: "0px",
            zIndex: 10000,
            padding: '2px',
            boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'
          }}>
            <div style={{
              maxWidth: '1280px',
              margin: '0 auto',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                <div className="float-animation" style={{
                  background: 'linear-gradient(to bottom right, rgb(52, 211, 153), rgb(20, 184, 166))',
                  padding: '12px',
                  borderRadius: '16px',
                  boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                }}>
                  <Sparkles />
                </div>
                <div>
                  <h1 style={{
                    fontSize: '1.875rem',
                    fontWeight: 'bold',
                    background: 'linear-gradient(to right, rgb(209, 250, 229), rgb(204, 251, 241), rgb(207, 250, 254))',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    fontFamily: "'Playfair Display', serif"
                  }}>
                    AI Assistant
                  </h1>
                  <p style={{ color: 'rgb(167, 243, 208)', fontSize: '0.75rem', marginTop: '-24px' }}>
                    Powered by Ravindra
                  </p>
                </div>
              </div>
              
              <button
                onClick={handleClearChat}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '8px 16px',
                  background: 'rgba(255, 255, 255, 0.1)',
                  color: 'rgb(209, 250, 229)',
                  borderRadius: '12px',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  cursor: 'pointer',
                  transition: 'all 0.3s'
                }}
                onMouseEnter={(e) => {
                  e.target.style.background = 'rgba(255, 255, 255, 0.2)';
                  e.target.style.transform = 'scale(1.05)';
                }}
                onMouseLeave={(e) => {
                  e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                  e.target.style.transform = 'scale(1)';
                }}
              >
                <Trash2 />
                <span style={{ fontSize: '0.875rem', fontWeight: '500' }}>Clear</span>
              </button>
            </div>
          </div>

          {/* Messages */}
          <div className="scrollbar-custom" style={{
            flex: 'none',
            height: 'calc(100vh - var(--header-height, 96px) - var(--input-height, 88px))',
            overflowY: 'auto',
            padding: '24px'
          }}>
            <div style={{
              maxWidth: '1280px',
              margin: '0 auto',
              display: 'flex',
              flexDirection: 'column',
              gap: '24px'
            }}>
              {messages.length === 0 && (
                <div className="message-enter" style={{ textAlign: 'center', paddingTop: '96px', paddingBottom: '96px' }}>
                  <div className="glass-effect" style={{
                    display: 'inline-block',
                    padding: '32px',
                    borderRadius: '24px',
                    marginBottom: '32px'
                  }}>
                    <Bot />
                  </div>
                  <h2 style={{
                    fontSize: '1.875rem',
                    fontWeight: 'bold',
                    color: 'rgb(236, 253, 245)',
                    marginBottom: '16px',
                    fontFamily: "'Playfair Display', serif"
                  }}>
                    Welcome! How can I help you today?
                  </h2>
                  <p style={{
                    color: 'rgb(167, 243, 208)',
                    fontSize: '1rem',
                    maxWidth: '28rem',
                    margin: '0 auto',
                    lineHeight: '1.75'
                  }}>
                    Ask me anythingâ€”from creative ideas to technical questions. I'm here to assist with lightning-fast responses.
                  </p>
                </div>
              )}

              {messages.map((message, index) => (
                <div
                  key={index}
                  className="message-enter"
                  style={{
                    display: 'flex',
                    gap: '16px',
                    justifyContent: message.role === 'assistant' ? 'flex-start' : 'flex-end'
                  }}
                >
                  {message.role === 'assistant' && (
                    <div style={{ flexShrink: 0, paddingTop: '4px' }}>
                      <div style={{
                        background: 'linear-gradient(to bottom right, rgb(52, 211, 153), rgb(20, 184, 166))',
                        padding: '10px',
                        borderRadius: '12px',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                      }}>
                        <Bot />
                      </div>
                    </div>
                  )}

                  <div
                    className="message-bubble glass-effect"
                    style={{
                      maxWidth: '80%',
                      borderRadius: '16px',
                      padding: '16px 20px',
                      boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                      transition: 'all 0.3s',
                      ...(message.role === 'assistant' ? {
                        color: 'rgb(236, 253, 245)',
                        borderLeft: '4px solid rgb(52, 211, 153)'
                      } : {
                        background: 'linear-gradient(to bottom right, rgb(16, 185, 129), rgb(20, 184, 166))',
                        color: 'white'
                      })
                    }}
                  >
                    <p
                      style={{
                        fontSize: '0.875rem',
                        lineHeight: '1.75',
                        whiteSpace: 'pre-wrap',
                        margin: 0
                      }}
                      dangerouslySetInnerHTML={{ __html: sanitizeAndHighlight(message.content) }}
                    />
                  </div>

                  {message.role === 'user' && (
                    <div style={{ flexShrink: 0, paddingTop: '4px' }}>
                      <div style={{
                        background: 'rgba(255, 255, 255, 0.2)',
                        backdropFilter: 'blur(4px)',
                        padding: '10px',
                        borderRadius: '12px',
                        border: '1px solid rgba(255, 255, 255, 0.3)'
                      }}>
                        <User />
                      </div>
                    </div>
                  )}
                </div>
              ))}

              {isLoading && (
                <div className="message-enter" style={{ display: 'flex', gap: '16px' }}>
                  <div style={{ flexShrink: 0, paddingTop: '4px' }}>
                    <div style={{
                      background: 'linear-gradient(to bottom right, rgb(52, 211, 153), rgb(20, 184, 166))',
                      padding: '10px',
                      borderRadius: '12px',
                      boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                    }}>
                      <Bot />
                    </div>
                  </div>
                  <div className="glass-effect" style={{
                    borderRadius: '16px',
                    padding: '16px 20px',
                    borderLeft: '4px solid rgb(52, 211, 153)'
                  }}>
                    <div className="typing-indicator" style={{ display: 'flex', gap: '6px' }}>
                      <span style={{
                        width: '10px',
                        height: '10px',
                        background: 'rgb(167, 243, 208)',
                        borderRadius: '50%'
                      }}></span>
                      <span style={{
                        width: '10px',
                        height: '10px',
                        background: 'rgb(167, 243, 208)',
                        borderRadius: '50%'
                      }}></span>
                      <span style={{
                        width: '10px',
                        height: '10px',
                        background: 'rgb(167, 243, 208)',
                        borderRadius: '50%'
                      }}></span>
                    </div>
                  </div>
                </div>
              )}

              <div ref={messagesEndRef} />
            </div>
          </div>

          {/* Input */}
          <div id="app-input">
            <form onSubmit={handleSendMessage} style={{
              maxWidth: '1280px',
              margin: '10px 100px 7px 100px'
            }}>
              <div style={{ display: 'flex', gap: '12px' }}>
                <input
                  ref={inputRef}
                  type="text"
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  placeholder="Type your message..."
                  disabled={isLoading}
                  style={{
                    flex: 1,
                    background: 'rgba(255, 255, 255, 0.05)',
                    backdropFilter: 'blur(20px)',
                    border: '1px solid rgba(255, 255, 255, 0.2)',
                    borderRadius: '16px',
                    padding: '16px 24px',
                    color: 'rgb(236, 253, 245)',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'all 0.3s'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = 'rgb(52, 211, 153)';
                    e.target.style.boxShadow = '0 0 0 2px rgba(52, 211, 153, 0.3)';
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    e.target.style.boxShadow = 'none';
                  }}
                />
                <button
                  type="submit"
                  disabled={!inputValue.trim() || isLoading}
                  style={{
                    background: 'linear-gradient(to bottom right, rgb(16, 185, 129), rgb(20, 184, 166))',
                    color: 'white',
                    padding: '16px 24px',
                    borderRadius: '16px',
                    border: 'none',
                    cursor: 'pointer',
                    transition: 'all 0.3s',
                    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
                    opacity: (!inputValue.trim() || isLoading) ? 0.5 : 1
                  }}
                  onMouseEnter={(e) => {
                    if (!(!inputValue.trim() || isLoading)) {
                      e.target.style.transform = 'scale(1.05)';
                      e.target.style.background = 'linear-gradient(to bottom right, rgb(52, 211, 153), rgb(45, 212, 191))';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.transform = 'scale(1)';
                    e.target.style.background = 'linear-gradient(to bottom right, rgb(16, 185, 129), rgb(20, 184, 166))';
                  }}
                >
                  <Send />
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    ReactDOM.render(<GroqChatbot />, document.getElementById('root'));
  </script>
</body>
</html>
